<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Digitaler Fragebogen</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #question { font-size: 18px; margin-bottom: 15px; }
    button { margin: 5px; padding: 8px 16px; }
    textarea, select, input[type=text], input[type=number], input[type=date] {
      width: 100%; margin: 5px 0; padding: 6px;
    }
    #upload, #attributes { margin-top: 20px; padding: 10px; border: 1px solid #ccc; display:none; }
    #done { margin-top: 20px; }
  </style>
</head>
<body>

<h2>Digitaler Fragebogen-michi</h2>
<div id="question"></div>
<button onclick="answer('Ja')">Ja</button>
<button onclick="answer('Nein')">Nein</button>

<div id="upload">
  <p><a id="upload-link" href="#" target="_blank">→ Datei hier hochladen</a></p>
</div>

<div id="attributes">
  <h4>Zusätzliche Angaben</h4>
  <form id="attrForm"></form>
  <button type="button" onclick="nextQuestion()">Weiter</button>
</div>

<div id="done" style="display:none;">
  <h3>Vielen Dank für Ihre Teilnahme!</h3>
</div>

<script>
(function() { emailjs.init("ueUbQfFPpdM5MC2z2"); })();
const SERVICE_ID = "service_b074ymd";
const TEMPLATE_ID = "template_omwd93k";

const EXCEL_URL = "https://raw.githubusercontent.com/Geralf1960/formular4/main/Empfaenger-Upload-Links-2.xlsx";
const QUESTIONS_URL = "https://raw.githubusercontent.com/Geralf1960/formular4/main/Fragen.xlsx";

let questions = [];
let answers = [];
let currentNode = null;
let stack = [];
let uploadLinks = {};

// Fragen aus Excel laden
async function loadQuestionsFromExcel() {
  const response = await fetch(QUESTIONS_URL);
  const arrayBuffer = await response.arrayBuffer();
  const workbook = XLSX.read(arrayBuffer, { type: "array" });
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const json = XLSX.utils.sheet_to_json(sheet);

  const map = {};
  json.forEach(row => {
    map[row.ID] = {
      id: row.ID,
      text: row.Frage,
      upload: row.Upload && row.Upload.toString().toLowerCase() === "true",
      ende: row.Ende && row.Ende.toString().toLowerCase() === "true",
      attributes: row.Attribute ? row.Attribute.split(";").map(a => parseAttribute(a)) : [],
      sub: []
    };
  });

  const roots = [];
  json.forEach(row => {
    if (row.ParentID) {
      if (map[row.ParentID]) map[row.ParentID].sub.push(map[row.ID]);
    } else {
      roots.push(map[row.ID]);
    }
  });

  questions = roots;
}

// Attribute parsen
function parseAttribute(def) {
  let [label, type, status] = def.split(":").map(x => x ? x.trim() : "");
  if (!type) type = "text";
  if (!status) status = "optional";
  return { label, type, required: status.toLowerCase() === "pflicht" };
}

// Upload-Links laden
async function loadExcel() {
  let response = await fetch(EXCEL_URL);
  let arrayBuffer = await response.arrayBuffer();
  let workbook = XLSX.read(arrayBuffer, { type: "array" });
  let sheet = workbook.Sheets[workbook.SheetNames[0]];
  let json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

  json.slice(1).forEach(row => {
    if (row[0] && row[1]) {
      uploadLinks[row[0].trim().toLowerCase()] = row[1].trim();
    }
  });
}

// Startformular
async function startForm() {
  await loadExcel();
  await loadQuestionsFromExcel();

  const params = new URLSearchParams(window.location.search);
  let user = params.get("user");
  if (!user || !uploadLinks[user.toLowerCase()]) {
    document.getElementById("question").innerText = "Kein Upload-Link für diesen Benutzer gefunden.";
    return;
  }
  currentNode = { sub: questions, idx: 0, user: user.toLowerCase() };
  showQuestion();
}

// Frage anzeigen
function showQuestion() {
  document.getElementById("upload").style.display = "none";
  document.getElementById("attributes").style.display = "none";

  if (!currentNode || currentNode.idx >= currentNode.sub.length) {
    if (stack.length > 0) {
      currentNode = stack.pop();
      showQuestion();
      return;
    }
    finishForm();
    return;
  }
  let q = currentNode.sub[currentNode.idx];
  document.getElementById("question").innerText = q.text;
}

// Antwort verarbeiten
function answer(ans) {
  let q = currentNode.sub[currentNode.idx];
  answers.push(q.text + ": " + ans);

  if (q.ende && ans === "Ja") {
    finishForm();
    return;
  }

  if (ans === "Ja") {
    if (q.upload) {
      document.getElementById("upload-link").href = uploadLinks[currentNode.user];
      document.getElementById("upload").style.display = "block";
    }
    if (q.attributes.length > 0) {
      renderAttributes(q.attributes);
      document.getElementById("attributes").style.display = "block";
      return;
    }
    if (q.sub.length > 0) {
      stack.push(currentNode);
      currentNode = { sub: q.sub, idx: 0, user: currentNode.user };
      showQuestion();
      return;
    }
  }

  currentNode.idx++;
  showQuestion();
}

// Dynamische Attribute rendern
function renderAttributes(attrDefs) {
  let form = document.getElementById("attrForm");
  form.innerHTML = "";

  attrDefs.forEach(def => {
    if (!def.label) return;

    let wrapper = document.createElement("div");
    wrapper.style.marginBottom = "8px";
    let lbl = document.createElement("label");
    lbl.innerText = def.label + (def.required ? " *" : "") + ": ";
    wrapper.appendChild(lbl);

    let input;

    // Dropdown
    if (def.type.startsWith("dropdown(")) {
      input = document.createElement("select");
      let opts = def.type.substring(9, def.type.length - 1).split(",");
      input.innerHTML = "<option value=''>Bitte wählen...</option>";
      opts.forEach(o => {
        let opt = document.createElement("option");
        opt.value = o.trim();
        opt.innerText = o.trim();
        input.appendChild(opt);
      });
    }
    // Boolean
    else if (def.type === "boolean") {
      input = document.createElement("select");
      input.innerHTML = "<option value=''>Bitte wählen...</option><option value='Ja'>Ja</option><option value='Nein'>Nein</option>";
    }
    // Checkbox (mehrere Optionen)
    else if (def.type.startsWith("checkbox(")) {
      let opts = def.type.substring(9, def.type.length - 1).split("|");
      opts.forEach(o => {
        let cbLabel = document.createElement("label");
        let cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = o.trim();
        cb.dataset.label = def.label;
        cbLabel.appendChild(cb);
        cbLabel.append(" " + o.trim());
        wrapper.appendChild(cbLabel);
        wrapper.appendChild(document.createElement("br"));
      });
      form.appendChild(wrapper);
      return;
    }
    // Date
    else if (def.type === "date") {
      input = document.createElement("input");
      input.type = "date";
    }
    // Number
    else if (def.type === "number") {
      input = document.createElement("input");
      input.type = "number";
    }
    // Text (Standard)
    else {
      input = document.createElement("input");
      input.type = "text";
    }

    if (def.required) input.required = true;
    input.dataset.label = def.label;
    wrapper.appendChild(input);
    form.appendChild(wrapper);
  });
}

// Weiter nach Attributen
function nextQuestion() {
  let form = document.getElementById("attrForm");
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  let q = currentNode.sub[currentNode.idx];
  let values = [];

  // Textfelder & Selects
  form.querySelectorAll("input:not([type=checkbox]), select").forEach(el => {
    if (el.value) values.push(`${el.dataset.label}: ${el.value}`);
  });

  // Checkbox-Gruppen
  let checkedGroups = {};
  form.querySelectorAll("input[type=checkbox]:checked").forEach(el => {
    if (!checkedGroups[el.dataset.label]) checkedGroups[el.dataset.label] = [];
    checkedGroups[el.dataset.label].push(el.value);
  });
  Object.entries(checkedGroups).forEach(([label, vals]) => {
    values.push(`${label}: ${vals.join(", ")}`);
  });

  if (values.length > 0) {
    answers[answers.length - 1] += " | " + values.join(" | ");
  }

  document.getElementById("attributes").style.display = "none";
  document.getElementById("upload").style.display = "none";

  if (q.sub.length > 0) {
    stack.push(currentNode);
    currentNode = { sub: q.sub, idx: 0, user: currentNode.user };
    showQuestion();
    return;
  }

  currentNode.idx++;
  showQuestion();
}

// Abschluss
function finishForm() {
  document.getElementById("question").style.display = "none";
  document.getElementById("done").style.display = "block";

  const params = new URLSearchParams(window.location.search);
  let user = params.get("user");

  emailjs.send(SERVICE_ID, TEMPLATE_ID, {
    from_email: user,
    answers: answers.join("\n")
  });
}

startForm();
</script>
</body>
</html>

